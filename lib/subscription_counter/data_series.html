<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>data_series.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../subscription_counter.html">subscription_counter.rb</a>
          <a class="source" href="campaign.html">campaign.rb</a>
          <a class="source" href="data_point.html">data_point.rb</a>
          <a class="source" href="data_series.html">data_series.rb</a>
          <a class="source" href="graph.html">graph.rb</a>
          <a class="source" href="report.html">report.rb</a>
          <a class="source" href="report/pdf.html">pdf.rb</a>
          <a class="source" href="statistics.html">statistics.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>data_series.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>While <code>Campaign.all</code> grabs all campaign dates and subscriber counts for a
given mailing list, my report actually target the last N campaigns 
(roughly corresponding to weeks in
Practicing Ruby&rsquo;s case). I created this <code>DataSeries</code> object to deal with that
issue as well as to provide a bit of a bufferzone between the code that
interacts with the <a href="http://apidocs.mailchimp.com/">MailChimp API</a> and the rest 
of the system. This in theory will make it easier for me to pull from other 
data sources in the future, and also makes testing easier.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">SubscriptionCounter</span>
  <span class="k">class</span> <span class="nc">DataSeries</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre>    </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Like most Ruby collections, the <code>DataSeries</code> object mixes in the <code>Enumerable</code>
module. While in this particular application I only use this for the <code>map</code>
method, it would be surprising to provide just <code>map</code> and not the rest of
what <code>Enumerable</code> provides.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    
    <span class="kp">include</span> <span class="no">Enumerable</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>While <code>DataSeries</code> is meant to be used with an array of <code>Campaign</code>
objects, the dependency is implicit and other objects could easily be
substituted. This is by design.</p>

<p>Using <code>each_cons</code> combined with <code>map</code> to traverse the campaign list is a 
handy way to simultaneously create a new <code>DataPoint</code> object for the current
campaign while also keeping track of the one that immediately
preceded it. Because this report covers both the current subscriber count
for any given week as well as the change in subscriber count since the
previous week, we need to keep track of this information. This explains
why we end up looking at <code>num_weeks+1</code> rather than <code>num_weeks</code> worth of
context.</p>

<p>Additionally, by introducing the <code>DataPoint</code> object, we make it so that the rest of
our report is completely independent of the MailChimp dependency and
the &ldquo;campaign&rdquo; vocabulary.</p>

<p>Note that each <code>DataPoint</code> is assigned a campaign number which corresponds
to Practicing Ruby issue numbers. While it&rsquo;s a bit awkward to do this
logic here, it&rsquo;s even more awkward to do it elsewhere, so this is where it
ended up.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">campaigns</span><span class="p">,</span> <span class="n">num_weeks</span><span class="p">)</span>
      <span class="n">campaign_number</span> <span class="o">=</span> <span class="n">campaigns</span><span class="o">.</span><span class="n">size</span> <span class="o">-</span> <span class="n">num_weeks</span>


      <span class="vi">@data</span> <span class="o">=</span> <span class="n">campaigns</span><span class="o">.</span><span class="n">last</span><span class="p">(</span><span class="n">num_weeks</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">each_cons</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">last</span><span class="p">,</span> <span class="n">current</span><span class="o">|</span>
        <span class="n">campaign_number</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="no">DataPoint</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:number</span> <span class="o">=&gt;</span> <span class="n">campaign_number</span><span class="p">,</span> 
                      <span class="ss">:date</span>   <span class="o">=&gt;</span> <span class="n">current</span><span class="o">.</span><span class="n">date</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y.%m.%d&quot;</span><span class="p">),</span> 
                      <span class="ss">:count</span>  <span class="o">=&gt;</span> <span class="n">current</span><span class="o">.</span><span class="n">subscriber_count</span><span class="p">,</span>
                      <span class="ss">:delta</span>  <span class="o">=&gt;</span> <span class="n">current</span><span class="o">.</span><span class="n">subscriber_count</span> <span class="o">-</span> <span class="n">last</span><span class="o">.</span><span class="n">subscriber_count</span><span class="p">)</span>
      <span class="k">end</span> 
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>This is pretty much the standard boilerplate that comes along with
mixing in the <code>Enumerable</code> method. Every time I type this I wish there was
some nice shortcut to it ;)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">each</span>
      <span class="n">data</span><span class="o">.</span><span class="n">each</span> <span class="p">{</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span> <span class="k">yield</span><span class="p">(</span><span class="n">e</span><span class="p">)</span> <span class="p">}</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>STYLE POINT: As mentioned in the discussion of <a href="campaign">Campaign</a>, 
I have been experimenting with making private accessors for values that I use
internally but not externally. Still not sure how I feel about this
approach.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">private</span>

    <span class="kp">attr_reader</span> <span class="ss">:data</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <p><em>NOTE: If you&rsquo;re attempting to do a comprehensive walkthrough of this codebase,
you will probably want to check out the <a href="data_point">DataPoint</a> object next.
Or if you&rsquo;d prefer to jump around, head back to the <a href="http://elm-city-craftworks.github.com/pr-reporting/lib/subscription_counter.html">project overview</a>
for an outline of all of the objects that make up this system.</em>  </p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
