<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>campaign.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../subscription_counter.html">subscription_counter.rb</a>
          <a class="source" href="campaign.html">campaign.rb</a>
          <a class="source" href="data_point.html">data_point.rb</a>
          <a class="source" href="data_series.html">data_series.rb</a>
          <a class="source" href="graph.html">graph.rb</a>
          <a class="source" href="report.html">report.rb</a>
          <a class="source" href="report/pdf.html">pdf.rb</a>
          <a class="source" href="statistics.html">statistics.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>campaign.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>The <code>Campaign</code> object is the only part of this application which interacts
directly with MailChimp, using Hominid to do so. <code>Campaign</code> objects 
are meant to be processed by the <a href="data_series.html">DataSeries</a> object,
and do not directly interact with the rest of the application. </p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">SubscriptionCounter</span>
  <span class="k">class</span> <span class="nc">Campaign</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <p>Calling <code>Campaign.all</code> fetches all the campaigns in mailchimp for
the list reference by <code>MAILCHIMP_SETTINGS[:list_id]</code></p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">all</span>
      <span class="n">api</span>  <span class="o">=</span> <span class="no">Hominid</span><span class="o">::</span><span class="no">API</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="no">MAILCHIMP_SETTINGS</span><span class="o">[</span><span class="ss">:api_key</span><span class="o">]</span><span class="p">)</span>
      <span class="n">data</span> <span class="o">=</span> <span class="n">api</span><span class="o">.</span><span class="n">campaigns</span><span class="p">(</span><span class="ss">:list_id</span> <span class="o">=&gt;</span> <span class="no">MAILCHIMP_SETTINGS</span><span class="o">[</span><span class="ss">:list_id</span><span class="o">]</span><span class="p">)</span><span class="o">[</span><span class="s2">&quot;data&quot;</span><span class="o">]</span>
      </pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Once the raw campaign data is downloaded from MailChimp, the data
gets normalized slightly and then transformed into <code>Campaign</code> 
instances.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      
      <span class="n">campaigns</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">map</span> <span class="k">do</span> <span class="o">|</span><span class="n">e</span><span class="o">|</span>
        <span class="kp">new</span><span class="p">(</span><span class="ss">:api</span>  <span class="o">=&gt;</span> <span class="n">api</span><span class="p">,</span> 
            <span class="ss">:id</span>   <span class="o">=&gt;</span> <span class="n">e</span><span class="o">[</span><span class="s2">&quot;id&quot;</span><span class="o">]</span><span class="p">,</span> 
            <span class="ss">:date</span> <span class="o">=&gt;</span> <span class="no">Date</span><span class="o">.</span><span class="n">parse</span><span class="p">(</span><span class="n">e</span><span class="o">[</span><span class="s2">&quot;send_time&quot;</span><span class="o">]</span><span class="p">))</span>
      <span class="k">end</span>
     </pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <p>To make life easier later, we sort the output by date. Note that this
makes use of the <code>Campaign#&lt;=&gt;</code> method automatically: Ruby is smart like
that.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>       
      <span class="n">campaigns</span><span class="o">.</span><span class="n">sort</span> 
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>Because <code>Campaign.new</code> is not meant to be called directly, I inject
the <code>Hominid::API</code> object without providing any sort of default. I use
<code>Hash#fetch</code> instead of <code>Hash#[]</code> here to make it so that an error will be
raised if you leave out any of the required parameters. This is helpful
in debugging, and can be useful for catching typos as well.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
      <span class="vi">@api</span>  <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:api</span><span class="p">)</span>
      <span class="vi">@id</span>   <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:id</span><span class="p">)</span>
      <span class="vi">@date</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="ss">:date</span><span class="p">)</span>
    <span class="k">end</span>

    <span class="kp">attr_reader</span> <span class="ss">:date</span>
    </pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <p>By implementing the <code>&lt;=&gt;</code> operator, a list of campaign objects (such as
the one in <code>Campaign.all)</code> can be sorted implicitly by date. Often times
when you implement <code>&lt;=&gt;</code>, you will also want to <code>include Comparable</code>, but
in this case it doesn&rsquo;t make much sense to mix in its methods.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">&lt;=&gt;</span><span class="p">(</span><span class="n">other</span><span class="p">)</span>
      <span class="n">date</span> <span class="o">&lt;=&gt;</span> <span class="n">other</span><span class="o">.</span><span class="n">date</span>
    <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>MailChimp&rsquo;s API has a cool, if a bit cumbersome API for filtering lists of
subscribers. The code below matches active subscribers who are not marked as
members of the &ldquo;Free Subscription&rdquo; group and have joined Practicing Ruby
before the date of the current campaign. The <code>campaign_segment_test</code> call
provides a simple count of how many subscribers match that filter,
which is exactly what is needed for this report.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="k">def</span> <span class="nf">subscriber_count</span>
      <span class="n">conditions</span> <span class="o">=</span> <span class="o">[</span><span class="p">{</span><span class="ss">:field</span> <span class="o">=&gt;</span> <span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="ss">:op</span> <span class="o">=&gt;</span> <span class="s2">&quot;lt&quot;</span><span class="p">,</span> <span class="ss">:value</span> <span class="o">=&gt;</span> <span class="nb">id</span><span class="p">},</span>
                    <span class="p">{</span><span class="ss">:field</span> <span class="o">=&gt;</span> <span class="s2">&quot;interests-</span><span class="si">#{</span><span class="no">MAILCHIMP_SETTINGS</span><span class="o">[</span><span class="ss">:grouping_id</span><span class="o">]</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> 
                     <span class="ss">:op</span>    <span class="o">=&gt;</span> <span class="s2">&quot;none&quot;</span><span class="p">,</span> 
                     <span class="ss">:value</span> <span class="o">=&gt;</span> <span class="s2">&quot;Free Subscription&quot;</span><span class="p">}</span><span class="o">]</span>

      <span class="n">api</span><span class="o">.</span><span class="n">campaign_segment_test</span> <span class="no">MAILCHIMP_SETTINGS</span><span class="o">[</span><span class="ss">:list_id</span><span class="o">]</span><span class="p">,</span> 
                                <span class="ss">:match</span>      <span class="o">=&gt;</span> <span class="s2">&quot;all&quot;</span><span class="p">,</span> 
                                <span class="ss">:conditions</span> <span class="o">=&gt;</span> <span class="n">conditions</span> 
    <span class="k">end</span>

    <span class="kp">private</span> </pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <p>I like to avoid referencing instance variables in all places except for
my constructor and explicitly defined setter methods. However, it seems
like a bad idea to define public accessors for data that won&rsquo;t be used by
the consumer. So lately I&rsquo;ve been defining private accessors. I am still
not sure if the break from conventions is justified for such a small API
difference. Comments welcome!</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>    <span class="kp">attr_reader</span> <span class="ss">:api</span><span class="p">,</span> <span class="ss">:id</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p><em>NOTE: If you&rsquo;re attempting to do a comprehensive walkthrough of this codebase,
you will probably want to check out the <a href="data_series">DataSeries</a> object next.
Or if you&rsquo;d prefer to jump around, head back to the <a href="http://elm-city-craftworks.github.com/pr-reporting/lib/subscription_counter.html">project overview</a>
for an outline of what each object does in this system.</em> </p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
