<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>pdf.rb</title>
  <link rel="stylesheet" href="http://jashkenas.github.com/docco/resources/docco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div id="jump_to">
    Jump To &hellip;
    <div id="jump_wrapper">
      <div id="jump_page">
          <a class="source" href="../../subscription_counter.html">subscription_counter.rb</a>
          <a class="source" href="../campaign.html">campaign.rb</a>
          <a class="source" href="../data_point.html">data_point.rb</a>
          <a class="source" href="../data_series.html">data_series.rb</a>
          <a class="source" href="../graph.html">graph.rb</a>
          <a class="source" href="../report.html">report.rb</a>
          <a class="source" href="pdf.html">pdf.rb</a>
          <a class="source" href="../statistics.html">statistics.rb</a>
      </div>
    </div>
  </div>
  <table cellspacing=0 cellpadding=0>
  <thead>
    <tr>
      <th class=docs><h1>pdf.rb</h1></th>
      <th class=code></th>
    </tr>
  </thead>
  <tbody>
    <tr id='section-1'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-1">&#182;</a>
        </div>
        <p>The <code>Report::PDF</code> object is responsible for composing the data provided by a
<code>Report</code> object into a nicely formatted PDF document. It uses
<a href="http://github.com/sandal/prawn">Prawn</a> to generate the text and tables, and
leans on <a href="https://github.com/alexgutteridge/rsruby">RSRuby</a> via my 
trivial <a href="/pr-reporting/lib/subscription_counter/graph.html">Graph</a> wrapper object.</p>

<p>Because the report this implements is meant to represent a fixed amount of
information at a time, I cut a lot of corners and sized/positioned many of the
report elements absolutely. Designing reports which need to grow and shrink
dynamically can be a real challenge, and would require much more clever
composition than what you see here. Prawn has facilities that make that sort
of reporting possible, but there is no need to make this particular report any
more challenging than it already is.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre><span class="k">module</span> <span class="nn">SubscriptionCounter</span>
  <span class="k">class</span> <span class="nc">Report</span>
    <span class="k">class</span> <span class="nc">PDF</span></pre></div>
      </td>
    </tr>
    <tr id='section-2'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-2">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-3'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-3">&#182;</a>
        </div>
        <p>Mixing in this module makes it possible to write <code>in2pt(1)</code> instead of
<code>Prawn::Measurements.in2pt(1)</code>. I am generally against doing this sort
of thing, but the alternatives are either to use this giant name in many
places or enable Prawn&rsquo;s monkeypatches to <code>Numeric</code>. Since neither of
those options sound good, it is worth it to sacrifice some
purity in the name of convenience. However, be sure to note that
mixing in a module for the sole purpose of stripping namespaces 
is a code smell and should usually be avoided.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="kp">include</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Measurements</span></pre></div>
      </td>
    </tr>
    <tr id='section-4'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-4">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre>      </pre></div>
      </td>
    </tr>
    <tr id='section-5'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-5">&#182;</a>
        </div>
        <p>When a <code>Report::PDF</code> instance is created, all the important drawing
operations are executed immediately. The text, tables, and graphs are
all drawn, and all that remains to be done is to explicitly write the
file via a call to <code>Report::PDF#save_as</code>. The current design does not
allow for anything useful to happen after a call to <code>Report::PDF.new</code>
but before a call to <code>Report::PDF#save_as</code>, but this API was set up this
way by design to leave room for extension points later.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">initialize</span><span class="p">(</span><span class="n">report</span><span class="p">)</span>
        <span class="vi">@report</span>   <span class="o">=</span> <span class="n">report</span>
        <span class="vi">@document</span> <span class="o">=</span> <span class="no">Prawn</span><span class="o">::</span><span class="no">Document</span><span class="o">.</span><span class="n">new</span><span class="p">(</span><span class="ss">:page_layout</span>   <span class="o">=&gt;</span> <span class="ss">:landscape</span><span class="p">,</span>
                                        <span class="ss">:top_margin</span>    <span class="o">=&gt;</span> <span class="n">in2pt</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span>
                                        <span class="ss">:bottom_margin</span> <span class="o">=&gt;</span> <span class="n">in2pt</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>

        <span class="vi">@document</span><span class="o">.</span><span class="n">float</span> <span class="p">{</span> <span class="n">draw_graphs</span> <span class="p">}</span>

        <span class="n">draw_header</span>
        <span class="n">draw_summary_table</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-6'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-6">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre>      </pre></div>
      </td>
    </tr>
    <tr id='section-7'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-7">&#182;</a>
        </div>
        <p>Because this report is meant to be run standalone, it makes sense to
write it to file. However, Prawn also supports writing a PDF to a
string, which could be handy if this report needed to be generated on
demand in a web application. YAGNI for now though.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">save_as</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
        <span class="n">document</span><span class="o">.</span><span class="n">render_file</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-8'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-8">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-9'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-9">&#182;</a>
        </div>
        <p>As mentioned before, I have started experimenting with private accessors
in my code. See the discussion in the private section of 
<a href="/pr-reporting/lib/subscription_counter">Campaign</a> for details</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="kp">private</span>

      <span class="kp">attr_reader</span> <span class="ss">:report</span><span class="p">,</span> <span class="ss">:document</span></pre></div>
      </td>
    </tr>
    <tr id='section-10'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-10">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre>      </pre></div>
      </td>
    </tr>
    <tr id='section-11'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-11">&#182;</a>
        </div>
        <p>The graphs use a hardcoded width of 40% of the page size (not
including margins) and separated by some vertical padding. These numbers
were arrived at through trial and error, but a better approach would be
to use a grid layout, which Prawn supports.</p>

<p>Note that this method makes use of <code>Dir.mktmpdir</code> to render the graphs
into a temporary directory. This makes it possible to embed them within
the document and then unlink the entire directory automatically as soon
as that is done. Prawn has support for rendering blobs of image data
directly, but as of right now <code>Graph</code> writes to file. I would have to
dig deeper into R to see if there is a way to avoid round tripping from
memory to file and back again.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">draw_graphs</span>
        <span class="n">image_options</span> <span class="o">=</span> <span class="p">{</span> <span class="ss">:width</span>    <span class="o">=&gt;</span> <span class="n">document</span><span class="o">.</span><span class="n">bounds</span><span class="o">.</span><span class="n">width</span> <span class="o">*</span> <span class="mi">0</span><span class="o">.</span><span class="mi">4</span><span class="p">,</span>
                          <span class="ss">:position</span> <span class="o">=&gt;</span> <span class="ss">:right</span> <span class="p">}</span>

        <span class="no">Dir</span><span class="o">.</span><span class="n">mktmpdir</span> <span class="k">do</span> <span class="o">|</span><span class="n">dir</span><span class="o">|</span>
          <span class="n">document</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">weekly_total_graph</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="n">image_options</span><span class="p">)</span>

          <span class="n">document</span><span class="o">.</span><span class="n">move_down</span><span class="p">(</span><span class="n">in2pt</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">5</span><span class="p">))</span>

          <span class="n">document</span><span class="o">.</span><span class="n">image</span><span class="p">(</span><span class="n">weekly_change_graph</span><span class="p">(</span><span class="n">dir</span><span class="p">),</span> <span class="n">image_options</span><span class="p">)</span>
        <span class="k">end</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-12'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-12">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre>      </pre></div>
      </td>
    </tr>
    <tr id='section-13'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-13">&#182;</a>
        </div>
        <p>The <code>weekly_total_graph</code> method takes a temporary directory to write its
image in, and then passes data from the <code>Report</code> object into
<code>Graph.build</code>. No transformations need to be done on the data because
<code>Report</code> is designed with the needs of this code in mind.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">weekly_total_graph</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
        <span class="n">total_graph_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2">/subscribers_by_week.png&quot;</span>

        <span class="n">total_graph</span> <span class="o">=</span> <span class="no">Graph</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
          <span class="ss">:title</span>    <span class="o">=&gt;</span> <span class="s2">&quot;Total subscribers by week&quot;</span><span class="p">,</span>
          <span class="ss">:labels</span>   <span class="o">=&gt;</span> <span class="n">report</span><span class="o">.</span><span class="n">issue_numbers</span><span class="p">,</span>
          <span class="ss">:data</span>     <span class="o">=&gt;</span> <span class="n">report</span><span class="o">.</span><span class="n">weekly_counts</span><span class="p">,</span>
          <span class="ss">:file</span>     <span class="o">=&gt;</span> <span class="n">total_graph_file</span>
        <span class="p">)</span>
        
        <span class="n">total_graph_file</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-14'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-14">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-15'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-15">&#182;</a>
        </div>
        <p>The <code>weekly_change_graph</code> method works in a similar manner to
<code>weekly_total_graph</code>. The only notable difference between the two
(aside from operating on different data) is that <code>weekly_change_graph</code>
provides a <em>baseline</em> value to <code>Graph.build</code>. This is used to render a
dotted horizontal line representing the average change in subscribers
over time.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">weekly_change_graph</span><span class="p">(</span><span class="n">dir</span><span class="p">)</span>
        <span class="n">change_graph_file</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">#{</span><span class="n">dir</span><span class="si">}</span><span class="s2">/change_by_week.png&quot;</span>

        <span class="n">change_graph</span> <span class="o">=</span> <span class="no">Graph</span><span class="o">.</span><span class="n">build</span><span class="p">(</span>
          <span class="ss">:title</span>    <span class="o">=&gt;</span> <span class="s2">&quot;Change in subscriber count by week&quot;</span><span class="p">,</span>
          <span class="ss">:labels</span>   <span class="o">=&gt;</span> <span class="n">report</span><span class="o">.</span><span class="n">issue_numbers</span><span class="p">,</span>
          <span class="ss">:data</span>     <span class="o">=&gt;</span> <span class="n">report</span><span class="o">.</span><span class="n">weekly_deltas</span><span class="p">,</span>
          <span class="ss">:baseline</span> <span class="o">=&gt;</span> <span class="n">report</span><span class="o">.</span><span class="n">average_delta</span><span class="p">,</span>
          <span class="ss">:file</span>     <span class="o">=&gt;</span> <span class="n">change_graph_file</span>
        <span class="p">)</span>

        <span class="n">change_graph_file</span>
      <span class="k">end</span>

      </pre></div>
      </td>
    </tr>
    <tr id='section-16'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-16">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre>      </pre></div>
      </td>
    </tr>
    <tr id='section-17'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-17">&#182;</a>
        </div>
        <p>I&rsquo;ve rendered the headers on this report in a bit of a ham-handed way.
Prawn can handle text wrapping within a column just fine, but because
this text is hard coded, I decided to simply embed linebreaks myself.
Don&rsquo;t take this approach as a best practice for working with Prawn :)</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">draw_header</span>
        <span class="n">document</span><span class="o">.</span><span class="n">text</span> <span class="s2">&quot;Practicing Ruby Weekly Report&quot;</span><span class="p">,</span> <span class="ss">:size</span> <span class="o">=&gt;</span> <span class="mi">24</span>
        <span class="n">document</span><span class="o">.</span><span class="n">text</span> <span class="s2">&quot;This report summarizes the subscriber count and &quot;</span><span class="o">+</span>
                       <span class="s2">&quot;change in</span><span class="se">\n</span><span class="s2">subscriber count over time.&quot;</span>

        <span class="n">document</span><span class="o">.</span><span class="n">move_down</span><span class="p">(</span><span class="n">in2pt</span><span class="p">(</span><span class="mi">0</span><span class="o">.</span><span class="mi">75</span><span class="p">))</span>
      <span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-18'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-18">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-19'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-19">&#182;</a>
        </div>
        <p>To render the summary table, a header row is added to the array of arrays
provided by <code>Report.table</code>. All columns except for the date column are
numeric, so it makes sense to right align them.</p>
      </td>
      <td class=code>
        <div class='highlight'><pre>      <span class="k">def</span> <span class="nf">draw_summary_table</span>
        <span class="n">header</span> <span class="o">=</span> <span class="o">[</span><span class="s2">&quot;Date&quot;</span><span class="p">,</span>              <span class="s2">&quot;Issue Number&quot;</span><span class="p">,</span> 
                  <span class="s2">&quot;Total Subscribers&quot;</span><span class="p">,</span> <span class="s2">&quot;Change in Subscribers&quot;</span><span class="o">]</span>

        <span class="n">body</span>   <span class="o">=</span> <span class="n">report</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="ss">:date</span><span class="p">,</span><span class="ss">:number</span><span class="p">,</span><span class="ss">:count</span><span class="p">,</span><span class="ss">:delta</span><span class="p">)</span>

        <span class="n">document</span><span class="o">.</span><span class="n">table</span><span class="p">(</span><span class="o">[</span><span class="n">header</span><span class="o">]+</span><span class="n">body</span><span class="p">)</span> <span class="k">do</span> <span class="o">|</span><span class="n">t</span><span class="o">|</span>
          <span class="n">t</span><span class="o">.</span><span class="n">header</span> <span class="o">=</span> <span class="kp">true</span>
          <span class="n">t</span><span class="o">.</span><span class="n">style</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="mi">1</span><span class="o">.</span><span class="n">.</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="p">{</span> <span class="o">|</span><span class="n">c</span><span class="o">|</span> <span class="n">c</span><span class="o">.</span><span class="n">align</span> <span class="o">=</span> <span class="ss">:right</span> <span class="p">}</span>
        <span class="k">end</span>
      <span class="k">end</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span></pre></div>
      </td>
    </tr>
    <tr id='section-20'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-20">&#182;</a>
        </div>
        <hr/>
      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
    <tr id='section-21'>
      <td class=docs>
        <div class="pilwrap">
          <a class="pilcrow" href="#section-21">&#182;</a>
        </div>
        <p><em>NOTE</em>: If you&rsquo;ve been doing the guided walkthrough, congratulations, you&rsquo;ve
made it to the end! You can explore more by <a href="https://github.com/elm-city-craftworks/pr-reporting">checking out the repository on
Github</a>, or you can return to <a href="http://practicingruby.com">practicingruby.com</a> and
leave me a comment. Feedback is welcome!</p>

<p>If instead you&rsquo;ve been jumping around, you can go back to the <a href="/pr-reporting/lib/subscription_counter.html">project 
overview page</a> for an outline of all the objects in this system.</p>

      </td>
      <td class=code>
        <div class='highlight'><pre></pre></div>
      </td>
    </tr>
  </table>
</div>
</body>
